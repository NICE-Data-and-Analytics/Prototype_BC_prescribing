---
title: "Breast cancer prescribing"
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(reactable)

# prevents data loading in with numbers in scientific format
options(scipen=999)

```


The following document sets out the observed and expected usage of the breast cancer medicines abemaciclib and neratinib. These medicines were selected as we have access to both primary and secondary care prescribing data and they are largely prescribed for an identifiable cohort of patients where we can estimate expected usage.  

# Abemaciclib

## Relevant guidance

Abemaciclib, sold under the brand name Verzenios, was first recommended as a treatment for breast cancer in 2019, following publication of a NICE Technology appraisal (TA563). Since then, we have published two further Technology appraisals recommending abemiciclib for additional breast cancer indications. Details of currently published technology appraisals are included in the table below. 

<br>

```{r}

Abemaciclib_table3<- read_csv(here::here("data/Abemaciclib_table3.csv"))

reactable(Abemaciclib_table3, 
          columns = list(Title = colDef(minWidth = 400)))

```

## Therapeutic indications  

### Early Breast Cancer  

Abemiciclib in combination with endocrine therapy is indicated for the adjuvant treatment of adult patients with hormone receptor (HR)-positive, human epidermal growth factor receptor 2 (HER2)-negative, node-positive early breast cancer at high risk of recurrence.  

In pre- or perimenopausal women, aromatase inhibitor endocrine therapy should be combined with a luteinising hormone-releasing hormone (LHRH) agonist.  

### Advanced or Metastatic Breast Cancer  

Abemiciclib is indicated for the treatment of women with hormone receptor (HR)-positive, human epidermal growth factor receptor 2 (HER2)-negative locally advanced or metastatic breast cancer in combination with an aromatase inhibitor or fulvestrant as initial endocrine-based therapy, or in women who have received prior endocrine therapy.
In pre- or perimenopausal women, the endocrine therapy should be combined with a LHRH agonist.  

<br>

## Eligible population  

Around 4,000 people are expected to receive treatment with abemaciclib in England annually.  

This has been taken from the Resource impact template developed for the NICE technology appraisal 'Abemaciclib with endocrine therapy for adjuvant treatment of hormone receptor-positive, HER2-negative, node-positive early breast cancer at high risk of recurrence', published July 2022.  

<br>

```{r}

Abemaciclib_table1<- read_csv(here::here("data/Abemaciclib_table1.csv"))

reactable(Abemaciclib_table1)

```

<br>

## Observed usage  

The table below is taken from data in the April 2022 publication of the innovation scorecard. It shows secondary care prescribing data by quarter in England for abemaciclib, also includes the very small amount of primary care data observed in the period.  

```{r}

Abemaciclib_table2<- read_csv(here::here("data/Abemaciclib_table2.csv"))

reactable(Abemaciclib_table2)

```

<br>

Chart 1 The observed usage of abemaciclib has increased since it was first authorized in 2018. In 2021 it was approaching the estimated expected level of prescribing.  

```{r}

Abemaciclib_data3 <- read_csv(here::here("data/Abemaciclib3.csv"))

annotation <- data.frame(
   x = c(2019,2020.5, 2021),
   y = c(750,750,750),
   label = c("TA563", "TA725", "TA810"))

h_line <- 4059

ggplot(data=Abemaciclib_data3, aes(x=Year, y=People)) +
    geom_line(stat='identity',color="darkblue", fill= "#228096", size = 0.8) +
    geom_hline(yintercept = h_line) +
    geom_text(aes(2020, h_line, label = "Expected usage", vjust = -1)) +
    geom_point(fill= "#228096", size = 2) +
    ylim(0, 5000) +
    xlim(2018,2021)+
    theme_minimal() +
    labs(title = "Annual abemaciclib primary and secondary care prescribing, England, 2018-2021") +
    geom_text(data=annotation, aes(x=x, y=y, label=label),
           color="orange", 
           size=4 , angle=0, fontface="bold")

```

<br>

Chart 2 The observed usage of abemaciclib has increased since it was first authorized in 2018. In 2021 it was approaching the estimated expected level of prescribing. 

```{r}
library(dplyr)
library(stringr)
library(ggplot2)

# prevents data loading in with numbers in scientific format
options(scipen=999)

# Import and clean data ---------------------------------------------------

## The below code shows how you can import the data straight from the website. 
# To get the specific URL I right clicked the ZIP file on the NHSD website and clicked copy link address.
temp <- tempfile()
download.file("https://files.digital.nhs.uk/AE/807A0E/Output-Utilisation.zip", temp)

# Read in the national csv and prepare for charting
national_df <- readr::read_csv(unz(temp, "nice-tech-apps-eng-apr22-Nat-Utilisation.csv"))
    
clean_df <- national_df %>% 
    # filter the data to get only abemaciclib and neratinib
    filter(str_detect(treatment_name, "abemaciclib|neratinib")) %>% 
    # Group the data by the columns we want to keep
    group_by(year, quarter, year_quarter, treatment_name, 
             numerator_unit, denominator_unit, value_unit) %>% 
    # Sum the numerator to include both prim/sec care, take the first population value as it is same for all, and
    # recalculate the ADDs per 100,000
    summarise(numerator = sum(numerator),
              denominator = first(denominator),
              value = numerator/(denominator/100000)) %>% 
    # Add ungroup to make sure the modified table isn't saved as a grouped table. This can cause issues when graphing
    ungroup() %>% 
    # Calculate people and people per 100,000 population
    mutate(people = numerator/91,
           people_per_100000 = people/(denominator/100000)) %>% 
    # This is a very convoluted way of converting the year and quarter columns into a date, this will make 
    # graphing much easier as we can use the date column on the x axis
    mutate(year = as.character(year),
           quarter = as.character(quarter),
           year = case_when(
               quarter  %in% c("1", "2", "3") ~ paste0("20", str_sub(year, 3, 4)),
               quarter == "4" ~ paste0("20", str_sub(year, 6, 7))),
           quarter = case_when(
               quarter == "4" ~ "3",
               quarter == "3" ~ "12",
               quarter == "2" ~ "9",
               quarter == "1" ~ "6"),
           date = lubridate::make_date(year, quarter, "1")) %>% 
    # remove the columns we dont need and move date to start
    select(-c(year, quarter)) %>% 
    select(date, everything())


# Make chart --------------------------------------------------------------

# Simple chart made using data

h_line2 <- 1015

clean_df %>% 
    filter(str_detect(treatment_name, "abemaciclib")) %>% 
    ggplot(aes(x = date, y = people)) +
    geom_line(color = "#228096", size = 1) +
    geom_point(size = 2, color = "#228096") +
    #geom_vline(xintercept = lubridate::make_date("2019", "02", "27"), 
    #           linetype = "dashed", 
    #           colour = "black", size = 0.6)+
    theme_minimal() +
    labs(title = "Quarterly abemaciclib primary and secondary care prescribing, England, 2018-2021") +
    geom_hline(yintercept = h_line2) +
    ylim(0, 1500)
```

